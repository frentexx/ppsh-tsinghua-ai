<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æ¸…è¯ AI åŠ©æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-green-50 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-white shadow-sm px-4 py-3 flex justify-between items-center z-10 border-b border-green-100">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md">
                <i class="fa-solid fa-leaf"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-wide">å°æ¸…è¯ AI åŠ©æ‰‹</h1>
                <p class="text-xs text-green-600 font-medium">å±åŒ—åŸæ°‘ç­å°ˆå±¬è«®è©¢ (v2.0)</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="loginBtn" class="text-sm bg-white border border-green-500 text-green-600 px-3 py-1.5 rounded-full hover:bg-green-50 transition shadow-sm">
                <i class="fa-brands fa-google mr-1"></i> ç™»å…¥
            </button>
            <button id="adminBtn" class="hidden text-sm bg-gray-800 text-white px-3 py-1.5 rounded-full hover:bg-gray-700 transition shadow-sm">
                <i class="fa-solid fa-gear mr-1"></i> å¾Œå°
            </button>
            <button id="logoutBtn" class="hidden text-sm bg-red-50 text-red-500 border border-red-200 px-3 py-1.5 rounded-full hover:bg-red-100 transition shadow-sm">
                <i class="fa-solid fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- èŠå¤©å€ -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar scroll-smooth">
        <div class="flex items-start gap-2.5">
            <div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>
            <div class="flex flex-col gap-1 w-full max-w-[85%]">
                <div class="flex flex-col leading-1.5 p-4 border-gray-200 bg-white rounded-e-xl rounded-es-xl shadow-sm">
                    <p class="text-sm font-normal text-gray-900">Nga'ay hoï¼æˆ‘æ˜¯å‡ç´šç‰ˆçš„å°æ¸…è¯ AI åŠ©æ‰‹ã€‚ç¾åœ¨æˆ‘çš„åæ‡‰æ›´å¿«äº†ï¼è«‹å•æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ</p>
                </div>
            </div>
        </div>
    </main>

    <!-- è¼¸å…¥å€ -->
    <footer class="bg-white p-3 border-t border-gray-200 z-10 pb-safe">
        <div class="relative flex items-center gap-2 max-w-4xl mx-auto">
            <input type="text" id="userInput" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-full focus:ring-green-500 focus:border-green-500 block w-full p-3 pl-4 shadow-sm outline-none transition" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." autocomplete="off">
            <button id="sendBtn" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-3 w-10 h-10 flex items-center justify-center shadow-md transition disabled:opacity-50">
                <i class="fa-solid fa-paper-plane text-sm"></i>
            </button>
        </div>
        <p id="systemStatus" class="text-center text-[10px] text-gray-400 mt-2">ç³»çµ±æº–å‚™å°±ç·’</p>
    </footer>

    <!-- å¾Œå° Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">çŸ¥è­˜åº«ç®¡ç† (JSON)</h2>
                <button id="closeAdminBtn" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-sm text-yellow-800">
                    <p>è«‹ä¸Šå‚³ <b>knowledge.json</b> æª”æ¡ˆã€‚</p>
                </div>
                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-solid fa-file-code text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-500">é»æ“Šä¸Šå‚³ JSON</p>
                    </div>
                    <input id="fileInput" type="file" class="hidden" accept=".json" />
                </label>
                <div id="uploadStatus" class="hidden text-center text-sm font-medium"></div>
                <button id="saveKnowledgeBtn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 shadow-lg disabled:bg-gray-400">æ›´æ–°çŸ¥è­˜åº«</button>
            </div>
        </div>
    </div>

<!-- SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ================= é…ç½®å€åŸŸ =================
        const firebaseConfig = {
            // TODO: è«‹å¡«å…¥æ‚¨çœŸå¯¦çš„ Firebase Config
            apiKey: "AIzaSyDdj_LLuF4SpgfEoMCDDdFEZpD0hZEj9YA",
			authDomain: "ppsh-tsinghua-ai.firebaseapp.com",
			projectId: "ppsh-tsinghua-ai",
			storageBucket: "ppsh-tsinghua-ai.firebasestorage.app",
			messagingSenderId: "937217635366",
			appId: "1:937217635366:web:bfb71d3822bd329df7a2e7",
			measurementId: "G-8LFTJM0REX"
        };
        const GEMINI_API_KEY = "AIzaSyADr8yWa5_Mgh7Omdvi9LCJ-9SRRq3DLPI"; 
        const ADMIN_EMAIL = "fuwen@ppsh.ptc.edu.tw";
        // ===========================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let knowledgeData = null;
        let currentUser = null;
        let fileContent = "";

        // UI Elements (ç­‰å¾… DOM è¼‰å…¥)
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminBtn = document.getElementById('adminBtn');
            const chatContainer = document.getElementById('chatContainer');
            const statusLabel = document.getElementById('systemStatus');
            const uploadStatus = document.getElementById('uploadStatus');
            const saveBtn = document.getElementById('saveKnowledgeBtn');
            const fileInput = document.getElementById('fileInput');
            const sendBtn = document.getElementById('sendBtn');
            const userInput = document.getElementById('userInput');
            const adminModal = document.getElementById('adminModal');
            const closeAdminBtn = document.getElementById('closeAdminBtn');

            // ç™»å…¥é‚è¼¯
            loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
            logoutBtn.addEventListener('click', () => signOut(auth));
            
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    if (user.email === ADMIN_EMAIL) adminBtn.classList.remove('hidden');
                } else {
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    adminBtn.classList.add('hidden');
                }
            });

            // å¾Œå°ç®¡ç†
            adminBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
            closeAdminBtn.addEventListener('click', () => adminModal.classList.add('hidden'));

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        fileContent = JSON.stringify(json);
                        uploadStatus.textContent = `âœ… JSON æ ¼å¼æ­£ç¢º (${file.size} bytes)`;
                        uploadStatus.className = "text-center text-sm font-medium text-green-600";
                    } catch (err) {
                        uploadStatus.textContent = `âŒ JSON éŒ¯èª¤: ${err.message}`;
                        uploadStatus.className = "text-center text-sm font-medium text-red-500";
                    }
                };
                reader.readAsText(file);
            });

            saveBtn.addEventListener('click', async () => {
                if (!fileContent) return alert("è«‹å…ˆé¸æ“‡æœ‰æ•ˆçš„ JSON æª”æ¡ˆ");
                saveBtn.disabled = true;
                saveBtn.textContent = "å¯«å…¥ä¸­...";
                try {
                    await setDoc(doc(db, "settings", "knowledge_json"), {
                        content: fileContent,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.email
                    });
                    
                    // ç«‹å³è®€å›é©—è­‰
                    const docSnap = await getDoc(doc(db, "settings", "knowledge_json"));
                    if (docSnap.exists()) {
                        knowledgeData = JSON.parse(docSnap.data().content);
                        alert("ğŸ‰ æ›´æ–°æˆåŠŸï¼çŸ¥è­˜åº«å·²é‡æ–°è¼‰å…¥ã€‚");
                        adminModal.classList.add('hidden');
                    }
                } catch (e) {
                    alert(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = "æ›´æ–°çŸ¥è­˜åº«";
                }
            });

            // åˆå§‹è¼‰å…¥
            async function loadKnowledge() {
                try {
                    const docSnap = await getDoc(doc(db, "settings", "knowledge_json"));
                    if (docSnap.exists()) {
                        knowledgeData = JSON.parse(docSnap.data().content);
                        statusLabel.textContent = "çŸ¥è­˜åº«å·²å°±ç·’";
                        console.log("Knowledge Keys:", Object.keys(knowledgeData));
                    }
                } catch (e) {
                    console.error(e);
                    statusLabel.textContent = "è®€å–å¤±æ•—";
                }
            }
            loadKnowledge();

            // AI é‚è¼¯ (ä¿®æ­£ URL)
            async function callGemini(question) {
                if (!knowledgeData) return "æŠ±æ­‰ï¼ŒçŸ¥è­˜åº«å°šæœªæº–å‚™å¥½ã€‚";

                // â˜…â˜…â˜… æ”¹ç”¨æœ€ç©©å®šçš„ gemini-pro æ¨¡å‹ â˜…â˜…â˜…
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
                
                statusLabel.textContent = "AI æ­£åœ¨æ€è€ƒ...";

                // ç°¡åŒ–æµç¨‹ï¼šå…ˆç›´æ¥å•ï¼Œè‹¥æ•ˆæœä¸å¥½å†åŠ  Router (ç‚ºäº†å…ˆæ’é™¤ 404 å•é¡Œ)
                // é€™è£¡æˆ‘å€‘ç›´æ¥æŠŠæœ€ç›¸é—œçš„å¹¾å€‹é¡åˆ¥åˆä½µé€å‡ºï¼Œé¿å… Router å¤±æ•—
                const contextData = (knowledgeData.admissions || "") + "\n" + (knowledgeData.curriculum || "") + "\n" + (knowledgeData.performance || "");
                
                const prompt = `
                    ä½ ç¾åœ¨æ˜¯ã€Œå°æ¸…è¯åŸä½æ°‘å¯¦é©—æ•™è‚²ç­ã€çš„æ‹›ç”Ÿè¡Œæ”¿è€å¸«ã€‚
                    è«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™å›ç­”å•é¡Œã€‚è‹¥è³‡æ–™ä¸­æ²’æœ‰ç­”æ¡ˆï¼Œè«‹èª å¯¦å‘ŠçŸ¥ã€‚
                    
                    ã€åƒè€ƒè³‡æ–™ã€‘ï¼š
                    ${contextData.substring(0, 30000)} ...

                    ã€å›ç­”è¦å‰‡ã€‘ï¼š
                    1. èªæ°£è¦ªåˆ‡ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
                    2. å§“åå»è­˜åˆ¥åŒ– (é™³â—‹æ˜)ã€‚

                    User: ${question}
                `;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error.message);
                    }

                    const data = await response.json();
                    statusLabel.textContent = "å›è¦†å®Œæˆ";
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    console.error(e);
                    return `æŠ±æ­‰ï¼ŒAI ç™¼ç”ŸéŒ¯èª¤: ${e.message}`;
                }
            }

            // Chat UI
            function appendMessage(role, text) {
                const isAI = role === 'ai';
                const div = document.createElement('div');
                div.className = `flex items-start gap-2.5 ${isAI ? '' : 'flex-row-reverse'}`;
                const avatar = isAI ? `<div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>` : `<div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0 flex items-center justify-center text-gray-500 text-xs"><i class="fa-solid fa-user"></i></div>`;
                const formattedText = isAI ? marked.parse(text) : text;
                div.innerHTML = `${avatar}<div class="flex flex-col gap-1 w-full max-w-[85%]"><div class="flex flex-col leading-1.5 p-3.5 border-gray-200 ${isAI ? 'bg-white rounded-e-xl rounded-es-xl' : 'bg-green-100 rounded-s-xl rounded-ee-xl'} shadow-sm"><div class="text-sm font-normal text-gray-900 prose prose-sm max-w-none ${isAI ? '' : 'text-gray-800'}">${formattedText}</div></div></div>`;
                chatContainer.appendChild(div);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            async function handleSend() {
                const text = userInput.value.trim();
                if (!text) return;
                userInput.value = '';
                appendMessage('user', text);
                const response = await callGemini(text);
                appendMessage('ai', response);
            }

            sendBtn.addEventListener('click', handleSend);
            userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
        });
    </script>
</body>
</html>