<!-- SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ================= é…ç½®å€åŸŸ =================
        const firebaseConfig = {
            // TODO: è«‹å¡«å…¥æ‚¨çœŸå¯¦çš„ Firebase Config
            apiKey: "AIzaSyDdj_LLuF4SpgfEoMCDDdFEZpD0hZEj9YA",
			authDomain: "ppsh-tsinghua-ai.firebaseapp.com",
			projectId: "ppsh-tsinghua-ai",
			storageBucket: "ppsh-tsinghua-ai.firebasestorage.app",
			messagingSenderId: "937217635366",
			appId: "1:937217635366:web:bfb71d3822bd329df7a2e7",
			measurementId: "G-8LFTJM0REX"
        };
        const GEMINI_API_KEY = "AIzaSyADr8yWa5_Mgh7Omdvi9LCJ-9SRRq3DLPI"; 
        const ADMIN_EMAIL = "fuwen@ppsh.ptc.edu.tw"; // TODO: è«‹ç¢ºèªé€™æ˜¯æ‚¨ç™»å…¥çš„ Email
        // ===========================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let knowledgeData = null;
        let currentUser = null;
        let fileContent = "";

        // UI å…ƒç´ 
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminBtn = document.getElementById('adminBtn');
        const chatContainer = document.getElementById('chatContainer');
        const statusLabel = document.getElementById('systemStatus');
        const uploadStatus = document.getElementById('uploadStatus');

        // ç™»å…¥é‚è¼¯
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        logoutBtn.addEventListener('click', () => signOut(auth));
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("å·²ç™»å…¥:", user.email); // Debug ç”¨
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                // å¯¬é¬†æª¢æŸ¥ï¼šåªè¦ Email ç›¸ç¬¦å°±é¡¯ç¤ºå¾Œå°
                if (user.email === ADMIN_EMAIL) {
                    adminBtn.classList.remove('hidden');
                } else {
                    console.warn(`ç™»å…¥ Email (${user.email}) èˆ‡ç®¡ç†å“¡ (${ADMIN_EMAIL}) ä¸ç¬¦ï¼Œéš±è—å¾Œå°`);
                }
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                adminBtn.classList.add('hidden');
            }
        });

        // å¾Œå°ç®¡ç†
        const adminModal = document.getElementById('adminModal');
        adminBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
        document.getElementById('closeAdminBtn').addEventListener('click', () => adminModal.classList.add('hidden'));

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // ç°¡å–®æª¢æŸ¥ JSON çµæ§‹æ˜¯å¦åŒ…å«é æœŸæ¬„ä½
                    if (!json.admissions && !json.general) throw new Error("JSON ç¼ºå°‘å¿…è¦æ¬„ä½ (admissions, general...)");
                    
                    fileContent = JSON.stringify(json);
                    uploadStatus.textContent = `âœ… JSON æ ¼å¼æ­£ç¢º (${file.size} bytes)`;
                    uploadStatus.className = "text-center text-sm font-medium text-green-600";
                } catch (err) {
                    uploadStatus.textContent = `âŒ JSON éŒ¯èª¤: ${err.message}`;
                    uploadStatus.className = "text-center text-sm font-medium text-red-500";
                    fileContent = "";
                }
            };
            reader.readAsText(file);
        });

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šå¯«å…¥å¾Œç«‹å³é©—è­‰ â˜…â˜…â˜…
        document.getElementById('saveKnowledgeBtn').addEventListener('click', async () => {
            if (!fileContent) return alert("è«‹å…ˆé¸æ“‡æœ‰æ•ˆçš„ JSON æª”æ¡ˆ");
            
            const btn = document.getElementById('saveKnowledgeBtn');
            btn.disabled = true;
            btn.textContent = "å¯«å…¥è³‡æ–™åº«ä¸­...";
            uploadStatus.textContent = "â³ æ­£åœ¨ä¸Šå‚³è‡³ Firestore...";
            uploadStatus.className = "text-center text-sm font-medium text-blue-600";

            try {
                // 1. å¯«å…¥
                await setDoc(doc(db, "settings", "knowledge_json"), {
                    content: fileContent,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.email
                });
                console.log("å¯«å…¥æˆåŠŸï¼Œé–‹å§‹é©—è­‰...");

                // 2. ç«‹å³è®€å›é©—è­‰
                const docSnap = await getDoc(doc(db, "settings", "knowledge_json"));
                if (docSnap.exists()) {
                    const data = JSON.parse(docSnap.data().content);
                    const keys = Object.keys(data);
                    
                    uploadStatus.textContent = `ğŸ‰ æˆåŠŸï¼å·²å¯«å…¥ä¸¦é©—è­‰ã€‚åŒ…å«é¡åˆ¥: ${keys.join(", ")}`;
                    uploadStatus.className = "text-center text-sm font-medium text-green-600";
                    
                    // æ›´æ–°æœ¬åœ°è®Šæ•¸ï¼Œä¸ç”¨åˆ·æ–°ç¶²é 
                    knowledgeData = data;
                    statusLabel.textContent = `çŸ¥è­˜åº«å°±ç·’ (v2.0, ${keys.length} é¡)`;
                    
                    setTimeout(() => {
                        adminModal.classList.add('hidden');
                        btn.disabled = false;
                        btn.textContent = "æ›´æ–°çŸ¥è­˜åº«";
                    }, 2000);
                } else {
                    throw new Error("å¯«å…¥çœ‹ä¼¼æˆåŠŸï¼Œä½†è®€å›æ™‚æ‰¾ä¸åˆ°æ–‡ä»¶ (Ghost Write)");
                }

            } catch (e) {
                console.error("ä¸Šå‚³å¤±æ•—è©³ç´°éŒ¯èª¤:", e);
                let errorMsg = e.message;
                if (e.code === 'permission-denied') {
                    errorMsg = "æ¬Šé™ä¸è¶³ï¼è«‹æª¢æŸ¥ Firestore Rules æˆ–ç™»å…¥å¸³è™Ÿã€‚";
                }
                uploadStatus.textContent = `âŒ ä¸Šå‚³å¤±æ•—: ${errorMsg}`;
                uploadStatus.className = "text-center text-sm font-medium text-red-500";
                btn.disabled = false;
                btn.textContent = "é‡è©¦";
            }
        });

        // åˆå§‹è¼‰å…¥
        async function loadKnowledge() {
            statusLabel.textContent = "æ­£åœ¨é€£ç·šè³‡æ–™åº«...";
            try {
                const docSnap = await getDoc(doc(db, "settings", "knowledge_json"));
                if (docSnap.exists()) {
                    knowledgeData = JSON.parse(docSnap.data().content);
                    statusLabel.textContent = "çŸ¥è­˜åº«å·²è¼‰å…¥";
                    console.log("Initial Load Success:", Object.keys(knowledgeData));
                } else {
                    statusLabel.textContent = "âš ï¸ è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè«‹é€²å¾Œå°ä¸Šå‚³";
                    console.warn("Firestore 'settings/knowledge_json' not found.");
                }
            } catch (e) {
                console.error("Load Error:", e);
                statusLabel.textContent = "é€£ç·šå¤±æ•— (è«‹çœ‹ Console)";
            }
        }
        loadKnowledge();

        // AI é‚è¼¯ (ä¿æŒä¸è®Š)
        async function callGemini(question) {
            if (!knowledgeData) return "æŠ±æ­‰ï¼ŒçŸ¥è­˜åº«å°šæœªæº–å‚™å¥½ï¼Œè«‹ç®¡ç†å“¡å…ˆä¸Šå‚³è³‡æ–™ã€‚";

            // ä½¿ç”¨æœ€æ–°çš„ Flash æ¨¡å‹
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            statusLabel.textContent = "AI æ­£åœ¨åˆ†é¡å•é¡Œ...";
            
            // ... (AI Router é‚è¼¯åŒä¸Šï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…) ...
             const routerPrompt = `
                ä½ æ˜¯åˆ†é¡å“¡ã€‚è«‹åˆ¤æ–·ä½¿ç”¨è€…çš„å•é¡Œå±¬æ–¼ä¸‹åˆ—å“ªä¸€é¡ï¼Œåªå›ç­”é¡åˆ¥ä»£ç¢¼ (admissions, curriculum, performance, general)ã€‚ä¸è¦å¤šé¤˜æ–‡å­—ã€‚
                
                é¡åˆ¥å®šç¾©ï¼š
                - admissions: æ‹›ç”Ÿã€å ±åã€ç°¡ç« ã€æ—¥æœŸã€è³‡æ ¼ã€åŠ åˆ†
                - curriculum: èª²ç¨‹ã€ä½å®¿ã€æ—èªã€ç¤¾åœ˜ã€è¿”é„‰æœå‹™
                - performance: å‡å­¸ã€æ¦œå–®ã€æ ¡å‹ã€å°±æ¥­ã€å¾—ç
                - general: å­¸æ ¡ä»‹ç´¹ã€äº¤é€šã€å…¶ä»–ç„¡æ³•æ­¸é¡

                User Question: ${question}
            `;

            let category = "general";
            try {
                const routerRes = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: routerPrompt }] }] })
                });
                const routerJson = await routerRes.json();
                let rawCat = routerJson.candidates[0].content.parts[0].text.trim().toLowerCase();
                
                if (rawCat.includes("admissions")) category = "admissions";
                else if (rawCat.includes("curriculum")) category = "curriculum";
                else if (rawCat.includes("performance")) category = "performance";
                
                console.log(`Router Decision: ${category}`);
            } catch (e) {
                console.warn("Router failed, fallback to general", e);
            }

            statusLabel.textContent = `AI æ­£åœ¨æŸ¥è©¢ [${category}] è³‡æ–™åº«...`;
            const contextData = knowledgeData[category] || knowledgeData['general'] || "";

            const answerPrompt = `
                ä½ ç¾åœ¨æ˜¯ã€Œå°æ¸…è¯åŸä½æ°‘å¯¦é©—æ•™è‚²ç­ã€çš„æ‹›ç”Ÿè¡Œæ”¿è€å¸«ã€‚
                è«‹æ ¹æ“šæä¾›çš„ã€è³‡æ–™ç‰‡æ®µã€‘å›ç­”å•é¡Œã€‚

                ã€è³‡æ–™ç‰‡æ®µ (${category})ã€‘ï¼š
                ${contextData.substring(0, 30000)} ... (è³‡æ–™çµæŸ)

                ã€å›ç­”è¦å‰‡ã€‘:
                1. èªæ°£è¦ªåˆ‡å°ˆæ¥­ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
                2. åƒ…æ ¹æ“šè³‡æ–™å›ç­”ï¼Œè‹¥ç„¡è³‡è¨Šè«‹èª å¯¦å‘ŠçŸ¥ä¸¦å»ºè­°è¯ç¹«è¾¦å…¬å®¤ (08-7937493 åˆ†æ©Ÿ 602-604)ã€‚
                3. å§“åå»è­˜åˆ¥åŒ– (é™³â—‹æ˜)ã€‚

                User Question: ${question}
            `;

            try {
                const answerRes = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: answerPrompt }] }] })
                });
                const answerJson = await answerRes.json();
                statusLabel.textContent = "å›è¦†å®Œæˆ";
                return answerJson.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return "æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }

        // Chat UI (ä¿æŒä¸è®Š)
        function appendMessage(role, text) {
            const isAI = role === 'ai';
            const div = document.createElement('div');
            div.className = `flex items-start gap-2.5 ${isAI ? '' : 'flex-row-reverse'}`;
            const avatar = isAI ? `<div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>` : `<div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0 flex items-center justify-center text-gray-500 text-xs"><i class="fa-solid fa-user"></i></div>`;
            const formattedText = isAI ? marked.parse(text) : text;
            div.innerHTML = `${avatar}<div class="flex flex-col gap-1 w-full max-w-[85%]"><div class="flex flex-col leading-1.5 p-3.5 border-gray-200 ${isAI ? 'bg-white rounded-e-xl rounded-es-xl' : 'bg-green-100 rounded-s-xl rounded-ee-xl'} shadow-sm"><div class="text-sm font-normal text-gray-900 prose prose-sm max-w-none ${isAI ? '' : 'text-gray-800'}">${formattedText}</div></div></div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        function showTyping() { const div = document.createElement('div'); div.id = 'typingIndicator'; div.className = 'flex items-start gap-2.5'; div.innerHTML = `<div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div><div class="flex flex-col gap-1"><div class="flex items-center space-x-1 p-4 bg-white rounded-e-xl rounded-es-xl shadow-sm h-10"><div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div><div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div><div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div></div></div>`; chatContainer.appendChild(div); chatContainer.scrollTop = chatContainer.scrollHeight; }
        async function handleSend() { const text = userInput.value.trim(); if (!text) return; userInput.value = ''; appendMessage('user', text); showTyping(); const response = await callGemini(text); document.getElementById('typingIndicator')?.remove(); appendMessage('ai', response); }
        document.getElementById('sendBtn').addEventListener('click', handleSend);
        document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

    </script>