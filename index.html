<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小清華 AI 助手</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-green-50 h-screen flex flex-col overflow-hidden">

    <!-- 頂部導航 -->
    <header class="bg-white shadow-sm px-4 py-3 flex justify-between items-center z-10 border-b border-green-100">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md">
                <i class="fa-solid fa-leaf"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-wide">小清華 AI 助手</h1>
                <p class="text-xs text-green-600 font-medium">屏北原民班專屬諮詢 (v2.0)</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="loginBtn" class="text-sm bg-white border border-green-500 text-green-600 px-3 py-1.5 rounded-full hover:bg-green-50 transition shadow-sm">
                <i class="fa-brands fa-google mr-1"></i> 登入
            </button>
            <button id="adminBtn" class="hidden text-sm bg-gray-800 text-white px-3 py-1.5 rounded-full hover:bg-gray-700 transition shadow-sm">
                <i class="fa-solid fa-gear mr-1"></i> 後台
            </button>
            <button id="logoutBtn" class="hidden text-sm bg-red-50 text-red-500 border border-red-200 px-3 py-1.5 rounded-full hover:bg-red-100 transition shadow-sm">
                <i class="fa-solid fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- 聊天區 -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar scroll-smooth">
        <div class="flex items-start gap-2.5">
            <div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>
            <div class="flex flex-col gap-1 w-full max-w-[85%]">
                <div class="flex flex-col leading-1.5 p-4 border-gray-200 bg-white rounded-e-xl rounded-es-xl shadow-sm">
                    <p class="text-sm font-normal text-gray-900">Nga'ay ho！我是升級版的小清華 AI 助手。現在我的反應更快了！請問有什麼我可以幫您的嗎？</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 輸入區 -->
    <footer class="bg-white p-3 border-t border-gray-200 z-10 pb-safe">
        <div class="relative flex items-center gap-2 max-w-4xl mx-auto">
            <input type="text" id="userInput" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-full focus:ring-green-500 focus:border-green-500 block w-full p-3 pl-4 shadow-sm outline-none transition" placeholder="請輸入您的問題..." autocomplete="off">
            <button id="sendBtn" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-3 w-10 h-10 flex items-center justify-center shadow-md transition disabled:opacity-50">
                <i class="fa-solid fa-paper-plane text-sm"></i>
            </button>
        </div>
        <p id="systemStatus" class="text-center text-[10px] text-gray-400 mt-2">系統準備就緒</p>
    </footer>

    <!-- 後台 Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">知識庫管理 (JSON)</h2>
                <button id="closeAdminBtn" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-sm text-yellow-800">
                    <p>請上傳 <b>knowledge.json</b> 檔案。</p>
                </div>
                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-solid fa-file-code text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-500">點擊上傳 JSON</p>
                    </div>
                    <input id="fileInput" type="file" class="hidden" accept=".json" />
                </label>
                <div id="uploadStatus" class="hidden text-center text-sm font-medium"></div>
                <button id="saveKnowledgeBtn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 shadow-lg disabled:bg-gray-400">更新知識庫</button>
            </div>
        </div>
    </div>

    <!-- SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ================= 配置區域 (請填入您的 Key) =================
        const firebaseConfig = {
            // TODO: 請填入您真實的 Firebase Config
            apiKey: "AIzaSyDdj_LLuF4SpgfEoMCDDdFEZpD0hZEj9YA",
			authDomain: "ppsh-tsinghua-ai.firebaseapp.com",
			projectId: "ppsh-tsinghua-ai",
			storageBucket: "ppsh-tsinghua-ai.firebasestorage.app",
			messagingSenderId: "937217635366",
			appId: "1:937217635366:web:bfb71d3822bd329df7a2e7",
			measurementId: "G-8LFTJM0REX"
        };
        const GEMINI_API_KEY = "AIzaSyCb1o4uO0iAzJ-RQG05sJjC94d4i7xl5lQ"; // TODO: 請填入 Gemini API Key
        const ADMIN_EMAIL = "fuwen@ppsh.ptc.edu.tw"; // TODO: 確認管理員 Email
        // =============================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let knowledgeData = null; // 存儲 JSON 物件
        let currentUser = null;
        let fileContent = "";

        // UI Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminBtn = document.getElementById('adminBtn');
        const chatContainer = document.getElementById('chatContainer');
        const statusLabel = document.getElementById('systemStatus');

        // Auth Logic
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        logoutBtn.addEventListener('click', () => signOut(auth));
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                if (user.email === ADMIN_EMAIL) adminBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                adminBtn.classList.add('hidden');
            }
        });

        // Admin: Load & Save JSON
        const adminModal = document.getElementById('adminModal');
        adminBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
        document.getElementById('closeAdminBtn').addEventListener('click', () => adminModal.classList.add('hidden'));

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result); // 驗證是否為合法 JSON
                    fileContent = JSON.stringify(json); // 轉回字串存儲
                    document.getElementById('uploadStatus').textContent = `✅ JSON 驗證成功 (${file.size} bytes)`;
                    document.getElementById('uploadStatus').classList.remove('hidden', 'text-red-500');
                    document.getElementById('uploadStatus').classList.add('text-green-600');
                } catch (err) {
                    document.getElementById('uploadStatus').textContent = `❌ 格式錯誤: 不是有效的 JSON`;
                    document.getElementById('uploadStatus').classList.remove('hidden');
                    document.getElementById('uploadStatus').classList.add('text-red-500');
                    fileContent = "";
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('saveKnowledgeBtn').addEventListener('click', async () => {
            if (!fileContent) return alert("請先選擇有效的 JSON 檔案");
            try {
                await setDoc(doc(db, "settings", "knowledge_json"), { // 注意：改存到 knowledge_json 文件
                    content: fileContent,
                    updatedAt: new Date().toISOString()
                });
                alert("更新成功！");
                location.reload();
            } catch (e) {
                alert("更新失敗: " + e.message);
            }
        });

        // Load Knowledge
        async function loadKnowledge() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "knowledge_json"));
                if (docSnap.exists()) {
                    knowledgeData = JSON.parse(docSnap.data().content);
                    statusLabel.textContent = "知識庫已載入 (JSON 模式)";
                    console.log("Knowledge loaded keys:", Object.keys(knowledgeData));
                } else {
                    statusLabel.textContent = "⚠️ 知識庫為空，請聯絡管理員";
                }
            } catch (e) {
                console.error(e);
                statusLabel.textContent = "讀取失敗";
            }
        }
        loadKnowledge();

        // ================= AI Logic (Router Pattern) =================
        async function callGemini(question) {
            if (!knowledgeData) return "抱歉，知識庫尚未準備好。";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            // Step 1: 路由分類 (不傳知識庫，省 Token)
            statusLabel.textContent = "AI 正在思考分類...";
            
            const routerPrompt = `
                你是分類員。請判斷使用者的問題屬於下列哪一類，只回答類別代碼 (admissions, curriculum, performance, general)。不要多餘文字。
                
                類別定義：
                - admissions: 招生、報名、簡章、日期、資格、加分
                - curriculum: 課程、住宿、族語、社團、返鄉服務
                - performance: 升學、榜單、校友、就業、得獎
                - general: 學校介紹、交通、其他無法歸類

                User Question: ${question}
            `;

            let category = "general";
            try {
                const routerRes = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: routerPrompt }] }] })
                });
                const routerJson = await routerRes.json();
                let rawCat = routerJson.candidates[0].content.parts[0].text.trim().toLowerCase();
                
                // 簡單清洗回傳值
                if (rawCat.includes("admissions")) category = "admissions";
                else if (rawCat.includes("curriculum")) category = "curriculum";
                else if (rawCat.includes("performance")) category = "performance";
                
                console.log(`Router Decision: ${category}`);

            } catch (e) {
                console.warn("Router failed, fallback to general", e);
            }

            // Step 2: 檢索回答 (只傳送該類別的資料)
            statusLabel.textContent = "AI 正在撰寫回覆...";
            
            // 容錯：如果找不到該類別，就用 general，或者全丟(如果不大的話)
            const contextData = knowledgeData[category] || knowledgeData['general'] || "";

            const answerPrompt = `
                你現在是「小清華原住民實驗教育班」的招生行政老師。
                請根據提供的【資料片段】回答問題。

                【資料片段 (${category})】：
                ${contextData.substring(0, 30000)} ... (資料結束)

                【回答規則】:
                1. 語氣親切專業，使用繁體中文。
                2. 僅根據資料回答，若無資訊請誠實告知並建議聯繫辦公室 (08-7937493 分機 602-604)。
                3. 姓名去識別化 (陳○明)。

                User Question: ${question}
            `;

            try {
                const answerRes = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: answerPrompt }] }] })
                });
                const answerJson = await answerRes.json();
                statusLabel.textContent = "回覆完成";
                return answerJson.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return "抱歉，系統忙碌中 (429)，請稍後再試。";
            }
        }

        // Chat UI Logic
        const sendBtn = document.getElementById('sendBtn');
        const userInput = document.getElementById('userInput');

        function appendMessage(role, text) {
            const isAI = role === 'ai';
            const div = document.createElement('div');
            div.className = `flex items-start gap-2.5 ${isAI ? '' : 'flex-row-reverse'}`;
            const avatar = isAI 
                ? `<div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>`
                : `<div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0 flex items-center justify-center text-gray-500 text-xs"><i class="fa-solid fa-user"></i></div>`;
            
            const formattedText = isAI ? marked.parse(text) : text;
            div.innerHTML = `
                ${avatar}
                <div class="flex flex-col gap-1 w-full max-w-[85%]">
                    <div class="flex flex-col leading-1.5 p-3.5 border-gray-200 ${isAI ? 'bg-white rounded-e-xl rounded-es-xl' : 'bg-green-100 rounded-s-xl rounded-ee-xl'} shadow-sm">
                        <div class="text-sm font-normal text-gray-900 prose prose-sm max-w-none ${isAI ? '' : 'text-gray-800'}">
                            ${formattedText}
                        </div>
                    </div>
                </div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.id = 'typingIndicator';
            div.className = 'flex items-start gap-2.5';
            div.innerHTML = `<div class="w-8 h-8 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div><div class="flex flex-col gap-1"><div class="flex items-center space-x-1 p-4 bg-white rounded-e-xl rounded-es-xl shadow-sm h-10"><div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div><div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div><div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div></div></div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;
            userInput.value = '';
            appendMessage('user', text);
            showTyping();
            const response = await callGemini(text);
            document.getElementById('typingIndicator')?.remove();
            appendMessage('ai', response);
        }

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

    </script>
</body>
</html>